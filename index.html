<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Planning - Xero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { 'xero-blue': '#1C7ED6', 'xero-nav': '#1A2638' } } } }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; }
        .typing-indicator span { width: 6px; height: 6px; background: #94A3B8; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
        #home-view, #scenario-view { display: none; flex-direction: column; min-height: 100vh; }
        #home-view.active, #scenario-view.active { display: flex; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #10B981; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 1000; display: none; }
        .toast.show { display: block; animation: slideUp 0.3s ease; }
        .toast.error { background: #EF4444; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .scenario-card { border-left: 3px solid; padding: 12px 16px; margin-bottom: 8px; background: white; border-radius: 0 8px 8px 0; cursor: pointer; transition: all 0.2s; }
        .scenario-card:hover { background: #F8FAFC; }
        .scenario-card.expanded { background: #F0F9FF; }
        .scenario-card.current { border-color: #94A3B8; }
        .scenario-card.cost-only { border-color: #EF4444; }
        .scenario-card.revenue { border-color: #1C7ED6; }
        .scenario-card.revenue-green { border-color: #10B981; }
        .scenario-line { display: inline-block; width: 24px; height: 2px; margin-left: 8px; vertical-align: middle; }
        .scenario-line.dotted { border-top: 2px dotted #94A3B8; background: none; }
        .scenario-line.solid-red { background: #EF4444; }
        .scenario-line.solid-blue { background: #1C7ED6; }
        .scenario-line.solid-green { background: #10B981; }

        .quick-chip { display: inline-block; padding: 8px 16px; border: 1px solid #1C7ED6; color: #1C7ED6; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.15s; margin: 4px; }
        .quick-chip:hover { background: #EBF5FF; }

        .data-chip { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; margin-right: 8px; }
        .data-chip.wages { background: #DBEAFE; color: #1E40AF; }
        .data-chip.revenue { background: #D1FAE5; color: #065F46; }
        .data-chip.cost { background: #FEE2E2; color: #991B1B; }

        .refine-panel { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.1); z-index: 100; transition: right 0.3s ease; display: flex; flex-direction: column; }
        .refine-panel.open { right: 0; }
        .refine-tabs { display: flex; border-bottom: 1px solid #E5E7EB; }
        .refine-tab { flex: 1; padding: 16px; text-align: center; font-size: 14px; font-weight: 500; color: #64748B; cursor: pointer; border-bottom: 2px solid transparent; }
        .refine-tab.active { color: #1C7ED6; border-bottom-color: #1C7ED6; }
        .refine-content { flex: 1; overflow-y: auto; }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #F8FAFC; }
        .user-message { display: flex; justify-content: flex-end; margin-bottom: 16px; }
        .user-bubble { background: #1C7ED6; color: white; padding: 10px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; }
        .ai-message { margin-bottom: 16px; }
        .ai-bubble { background: white; padding: 16px; border-radius: 12px; font-size: 14px; line-height: 1.7; color: #374151; border: 1px solid #E5E7EB; }
        .ai-bubble p { margin-bottom: 12px; }
        .ai-bubble p:last-child { margin-bottom: 0; }
        .ai-bubble strong { font-weight: 600; color: #1E293B; }
        .ai-bubble ul { margin: 8px 0 12px 0; padding-left: 20px; }
        .ai-bubble li { margin: 6px 0; }

        .chat-input-area { padding: 16px; border-top: 1px solid #E5E7EB; background: white; }
        .chat-input-wrap { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 12px 16px; border: 1px solid #E5E7EB; border-radius: 24px; font-size: 14px; outline: none; }
        .chat-input:focus { border-color: #1C7ED6; }
        .chat-send { width: 40px; height: 40px; border-radius: 50%; background: #1C7ED6; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-send:hover { background: #1565C0; }

        .suggested-prompts { padding: 40px 20px; text-align: center; }
        .suggested-prompts h3 { font-size: 18px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .suggested-prompts p { font-size: 14px; color: #64748B; margin-bottom: 24px; }
        .prompt-chips { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }

        .refine-card { background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .refine-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .refine-card-title { font-weight: 600; font-size: 14px; color: #1E293B; display: flex; align-items: center; gap: 8px; }
        .refine-card-subtitle { font-size: 12px; color: #64748B; margin-bottom: 12px; }
        .refine-input-group { margin-bottom: 12px; }
        .refine-input-group label { display: block; font-size: 12px; color: #64748B; margin-bottom: 6px; }
        .refine-input-field { display: flex; align-items: center; border: 1px solid #E5E7EB; border-radius: 8px; padding: 8px 12px; background: white; }
        .refine-input-field span { color: #64748B; margin-right: 4px; }
        .refine-input-field input { border: none; outline: none; font-size: 14px; width: 100%; font-weight: 500; }
        .refine-slider-wrap { display: flex; align-items: center; gap: 8px; }
        .refine-slider-wrap input[type="range"] { flex: 1; height: 4px; -webkit-appearance: none; background: #E5E7EB; border-radius: 2px; }
        .refine-slider-wrap input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: white; border: 2px solid #1C7ED6; border-radius: 50%; cursor: pointer; }
        .refine-slider-value { font-size: 14px; font-weight: 600; color: #1C7ED6; min-width: 50px; }
        .refine-select { width: 100%; padding: 10px 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }

        .setup-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .setup-modal.open { display: flex; }
        .setup-content { background: white; border-radius: 12px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; }
        .setup-header { padding: 16px 20px; border-bottom: 1px solid #E5E7EB; display: flex; align-items: center; justify-content: space-between; }
        .setup-body { padding: 40px 32px; }
        .setup-title { font-size: 20px; font-weight: 600; color: #1E293B; text-align: center; margin-bottom: 8px; }
        .setup-subtitle { font-size: 14px; color: #64748B; text-align: center; margin-bottom: 32px; }
        .setup-input-wrap { position: relative; margin-bottom: 24px; }
        .setup-input { width: 100%; padding: 14px 48px 14px 16px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 14px; background: #F8FAFC; }
        .setup-input:focus { outline: none; border-color: #1C7ED6; background: white; }
        .setup-submit { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; background: #1C7ED6; color: white; border: none; cursor: pointer; }
        .setup-divider { font-size: 13px; color: #64748B; margin-bottom: 16px; }
        .template-option { padding: 12px 16px; border-radius: 8px; font-size: 14px; color: #374151; cursor: pointer; }
        .template-option:hover { background: #F0F9FF; color: #1C7ED6; }

        .key-insight-box { background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .key-insight-box.green { background: #ECFDF5; border-color: #A7F3D0; }
        .key-insight-badge { display: inline-block; background: #DBEAFE; color: #1E40AF; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 4px; margin-bottom: 12px; }
        .key-insight-badge.green { background: #D1FAE5; color: #065F46; }
        .key-insight-title { font-size: 16px; font-weight: 600; color: #1E293B; line-height: 1.4; margin-bottom: 12px; }
        .key-insight-desc { font-size: 13px; color: #475569; line-height: 1.5; margin-bottom: 16px; }

        .powered-badge { font-size: 11px; color: #64748B; display: flex; align-items: center; gap: 4px; }
        .powered-badge span { font-weight: 600; color: #1C7ED6; }

        #left-panel { transition: all 0.3s ease; }
        #left-panel.collapsed { width: 0; padding: 0; overflow: hidden; opacity: 0; }

        .share-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .share-modal.open { display: flex; }

        .scenario-type-badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 4px; }
        .scenario-type-badge.operational { background: #DBEAFE; color: #1E40AF; }
        .scenario-type-badge.strategic { background: #D1FAE5; color: #065F46; }

        .loss-text { color: #DC2626; font-weight: 600; }

        .account-code { font-family: 'Monaco', 'Consolas', monospace; font-size: 10px; color: #6B7280; background: #F3F4F6; padding: 2px 6px; border-radius: 3px; margin-left: 4px; }
        .data-source-badge { font-size: 10px; color: #059669; background: #D1FAE5; padding: 2px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
        .data-source-badge svg { width: 10px; height: 10px; }
        .locked-indicator { color: #059669; font-size: 10px; display: flex; align-items: center; gap: 4px; }
        .locked-indicator svg { width: 12px; height: 12px; }
    </style>
</head>
<body class="bg-gray-100">

<div id="toast" class="toast"></div>

<!-- API Modal -->
<div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <div class="bg-xero-blue px-6 py-4">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold text-white text-lg">Enable AI Chat</h3>
                <button onclick="closeApiModal()" class="text-white/80 hover:text-white text-xl">&times;</button>
            </div>
        </div>
        <div class="p-6">
            <p class="text-sm text-gray-600 mb-4">Enter your Anthropic API key to enable intelligent scenario refinement.</p>
            <div class="mb-4">
                <label class="text-sm font-medium text-gray-700 mb-2 block">API Key</label>
                <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm font-mono focus:border-xero-blue outline-none" onkeydown="if(event.key==='Enter') saveApiKey()">
                <p class="text-xs text-gray-400 mt-2"><a href="https://console.anthropic.com/" target="_blank" class="text-xero-blue hover:underline">Get API key from Anthropic Console</a></p>
            </div>
            <div id="api-status" class="mb-4 hidden"><div id="api-status-container" class="text-sm p-3 rounded-lg"></div></div>
            <div class="flex gap-3">
                <button onclick="saveApiKey()" class="flex-1 bg-xero-blue text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700">Enable</button>
                <button onclick="clearApiKey()" id="clear-key-btn" class="px-4 py-3 border rounded-lg text-gray-600 hidden hover:bg-gray-50">Clear</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="share-modal">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        <div class="px-6 py-4 border-b">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Share with Advisor</h3>
                <button onclick="closeShareModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
        </div>
        <div class="p-6">
            <p class="text-sm text-gray-600 mb-4">Share this scenario with your financial advisor or accountant for review.</p>
            <div class="mb-4">
                <label class="text-sm font-medium text-gray-700 mb-2 block">Advisor's email</label>
                <input type="email" id="advisor-email" value="bean.counter.bestie@xero.com" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:border-xero-blue outline-none">
            </div>
            <div class="mb-4">
                <label class="text-sm font-medium text-gray-700 mb-2 block">Add a message (optional)</label>
                <textarea id="share-message" rows="3" placeholder="Hey! ðŸŽ¯ Check out this scenario I'm planning..." class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:border-xero-blue outline-none resize-none"></textarea>
            </div>
            <button onclick="sendToAdvisor()" class="w-full bg-xero-blue text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700">Send to Advisor</button>
        </div>
    </div>
</div>

<!-- Setup Modal -->
<div id="setup-modal" class="setup-modal">
    <div class="setup-content">
        <div class="setup-header">
            <h3 class="text-sm font-medium text-gray-700">New scenario plan</h3>
            <button onclick="closeSetupModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        </div>
        <div class="setup-body">
            <h2 class="setup-title">What scenario would you like to model?</h2>
            <p class="setup-subtitle">We'll create some initial scenarios based on the next 12 months for you to compare</p>
            <div class="setup-input-wrap">
                <input type="text" id="scenario-question" class="setup-input" placeholder="e.g. Can I afford to hire an apprentice carpenter">
                <button onclick="submitScenario()" class="setup-submit">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>
            <p class="setup-divider">Or pick one to start...</p>
            <div class="space-y-1">
                <div class="template-option" onclick="selectTemplate('hiring')">Can I afford to hire an apprentice carpenter?</div>
                <div class="template-option" onclick="selectTemplate('hiring')">What if I need to increase trade wages by 10%?</div>
                <div class="template-option" onclick="selectTemplate('expansion')">Should I expand into residential renovations?</div>
                <div class="template-option" onclick="selectTemplate('expansion')">What if I open a second depot in the suburbs?</div>
            </div>
        </div>
    </div>
</div>

<!-- Home View -->
<div id="home-view" class="active">
    <header class="bg-xero-nav">
        <div class="flex items-center justify-between px-4 h-12">
            <div class="flex items-center">
                <div class="text-white font-bold text-xl mr-3">xero</div>
                <div class="text-gray-400 text-sm border-l border-gray-600 pl-3">Ironbark Building Co</div>
            </div>
            <nav class="flex items-center space-x-1 text-sm">
                <a href="#" class="px-3 py-2 text-gray-300 hover:text-white">Home</a>
                <a href="#" class="px-3 py-2 text-white bg-white/10 rounded">Reporting</a>
                <a href="#" class="px-3 py-2 text-gray-300 hover:text-white">Payroll</a>
            </nav>
            <div class="w-8 h-8 bg-amber-600 rounded-full flex items-center justify-center text-white text-sm font-medium">IB</div>
        </div>
    </header>

    <div class="bg-white border-b px-6 py-3">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-500">Reporting &gt;</p>
                <h1 class="text-lg font-semibold text-gray-900">Scenario planning</h1>
            </div>
            <button onclick="openSetupModal()" class="bg-xero-blue text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700">New scenario</button>
        </div>
    </div>

    <main class="flex-1 px-6 py-6 overflow-auto">
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-8 flex">
            <div class="flex-1 p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Make better business decisions</h2>
                <p class="text-gray-600 mb-6 max-w-lg text-sm">Model hiring costs, equipment investments, and expansion plans to see their impact on your bottom line.</p>
                <button onclick="openSetupModal()" class="bg-xero-blue text-white px-5 py-2.5 rounded text-sm font-medium hover:bg-blue-700">Create new scenario</button>
            </div>
            <div class="w-64 bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center">
                <div class="text-center text-white">
                    <svg class="w-16 h-16 mx-auto mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <div class="font-semibold text-sm">Scenario Planning</div>
                </div>
            </div>
        </div>

        <h3 class="text-sm font-semibold text-gray-900 mb-4">Scenario templates</h3>
        <div class="grid grid-cols-2 gap-4">
            <!-- OPERATIONAL: Hiring -->
            <div onclick="selectTemplate('hiring')" class="bg-white p-5 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border-2 border-transparent hover:border-blue-200">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-xero-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <span class="scenario-type-badge operational">OPERATIONAL</span>
                </div>
                <h4 class="font-semibold text-gray-900 mb-1">Hiring an Apprentice</h4>
                <p class="text-sm text-gray-500">Model the cost and project capacity of adding an apprentice tradesperson</p>
            </div>

            <!-- STRATEGIC: Expansion -->
            <div onclick="selectTemplate('expansion')" class="bg-white p-5 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border-2 border-transparent hover:border-green-200">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    <span class="scenario-type-badge strategic">STRATEGIC</span>
                </div>
                <h4 class="font-semibold text-gray-900 mb-1">Expanding Service Area</h4>
                <p class="text-sm text-gray-500">Model the investment and returns of opening a new depot or service region</p>
            </div>
        </div>
    </main>
</div>

<!-- Scenario View -->
<div id="scenario-view">
    <header class="bg-xero-nav">
        <div class="flex items-center justify-between px-4 h-12">
            <div class="flex items-center">
                <div class="text-white font-bold text-xl mr-3">xero</div>
                <div class="text-gray-400 text-sm border-l border-gray-600 pl-3">Ironbark Building Co</div>
            </div>
            <div class="flex items-center gap-3">
                <div class="powered-badge">Powered by <span>JAX</span></div>
                <div class="data-source-badge">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    Data Verified
                </div>
                <div id="api-status-indicator" class="text-xs px-2 py-1 rounded cursor-pointer" onclick="openApiModal()"></div>
            </div>
            <div class="w-8 h-8 bg-amber-600 rounded-full flex items-center justify-center text-white text-sm font-medium">IB</div>
        </div>
    </header>

    <div class="bg-white border-b px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="goHome()" class="text-gray-400 hover:text-gray-600">&times;</button>
                <h1 id="scenario-title" class="text-lg font-semibold text-gray-900">Scenario</h1>
                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">Saved</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openApiModal()" class="flex items-center gap-2 px-4 py-2 border-2 border-xero-blue text-xero-blue rounded-lg text-sm font-medium hover:bg-blue-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                    Enter API Key
                </button>
                <button onclick="openShareModal()" class="flex items-center gap-2 px-4 py-2 border rounded-lg text-sm text-gray-600 hover:bg-gray-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                    Share with Advisor
                </button>
                <button onclick="openRefinePanel()" class="flex items-center gap-2 px-4 py-2 bg-xero-blue text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                    Refine scenarios
                </button>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Left Panel -->
        <div id="left-panel" class="w-80 bg-white border-r overflow-y-auto p-5">
            <!-- HIRING Key Insight -->
            <div id="key-insight-hiring" class="key-insight-box">
                <div class="key-insight-badge">Key insight</div>
                <h3 class="key-insight-title" id="hiring-insight-title">An apprentice hire pays for itself by Month 5 with increased project capacity</h3>
                <p class="key-insight-desc" id="hiring-insight-desc">With $180k monthly revenue and 20% capacity increase, a $55k apprentice generating ~$36k/mo in new project work covers their cost within 5 months.</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askQuickReply('Break down the numbers')" class="quick-chip">Break down numbers</button>
                    <button onclick="askQuickReply('What about super and training costs?')" class="quick-chip">Super & training costs?</button>
                </div>
            </div>

            <!-- EXPANSION Key Insight -->
            <div id="key-insight-expansion" class="key-insight-box green hidden">
                <div class="key-insight-badge green">Key insight</div>
                <h3 class="key-insight-title" id="expansion-insight-title">New depot breakeven in 3 months â€” but expect losses until Month 9</h3>
                <p class="key-insight-desc" id="expansion-insight-desc">Your $75k setup + $8k/mo overhead vs $35k/mo expected revenue = breakeven in 3 months post-opening. Initial months will show losses due to upfront costs.</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askQuickReply('Explain the loss period')" class="quick-chip">Explain loss period</button>
                    <button onclick="askQuickReply('What are the risks?')" class="quick-chip">What are the risks?</button>
                </div>
            </div>

            <!-- HIRING Scenario Cards -->
            <div id="scenario-key-hiring">
                <div class="scenario-card current">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Current trajectory <span class="scenario-line dotted"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500" id="hiring-current-desc">$312,000 total profit â€¢ No hire</p>
                </div>

                <div class="scenario-card cost-only">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Hire (cost only) <span class="scenario-line solid-red"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500" id="hiring-cost-desc"><span class="loss-text">$266,167 total profit</span> â€¢ Wages cost, no new projects</p>
                </div>

                <div class="scenario-card revenue expanded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Hire (with projects) <span class="scenario-line solid-blue"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500 mb-2" id="hiring-revenue-desc">$398,000 total profit â€¢ With new project revenue</p>
                    <div class="expanded-details">
                        <div class="mb-2">
                            <span class="data-chip wages" id="hiring-wages-chip">Wages: $55k/yr</span>
                            <span class="data-chip revenue" id="hiring-revenue-chip">Capacity: +20%</span>
                        </div>
                        <p class="text-xs text-gray-600 mb-3">With 20% more project capacity (~$36k/mo extra work), the hire pays for itself by Month 5.</p>
                        <button onclick="openRefineManual()" class="flex items-center gap-2 text-xs text-gray-600 border rounded px-3 py-2 hover:bg-gray-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                            Refine manually
                        </button>
                    </div>
                </div>
            </div>

            <!-- EXPANSION Scenario Cards -->
            <div id="scenario-key-expansion" class="hidden">
                <div class="scenario-card current">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Current trajectory <span class="scenario-line dotted"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500" id="expansion-current-desc">$318,500 total profit â€¢ No expansion</p>
                </div>

                <div class="scenario-card cost-only">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Expand (cost only) <span class="scenario-line solid-red"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500" id="expansion-cost-desc"><span class="loss-text">$187,500 total profit</span> â€¢ Setup + overhead, no new clients</p>
                </div>

                <div class="scenario-card revenue-green expanded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-gray-900">Expand (with clients) <span class="scenario-line solid-green"></span></span>
                        <button class="text-gray-400">&#8942;</button>
                    </div>
                    <p class="text-xs text-gray-500 mb-2" id="expansion-revenue-desc">$376,000 total profit â€¢ With new regional clients</p>
                    <div class="expanded-details">
                        <div class="mb-2">
                            <span class="data-chip cost" id="expansion-setup-chip">Setup: $75k</span>
                            <span class="data-chip revenue" id="expansion-newrev-chip">New work: +$35k/mo</span>
                        </div>
                        <p class="text-xs text-gray-600 mb-3" id="expansion-payback-text">Breakeven in 3 months post-opening. Expect losses until Month 9.</p>
                        <button onclick="openRefineManual()" class="flex items-center gap-2 text-xs text-gray-600 border rounded px-3 py-2 hover:bg-gray-50">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                            Refine manually
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center - Chart -->
        <div class="flex-1 p-6 overflow-auto bg-gray-50">
            <div class="bg-white rounded-xl shadow-sm p-6 h-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-900">Monthly Profit Projection</h3>
                    <div class="flex items-center gap-3">
                        <span class="locked-indicator">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                            Locked to P&L
                        </span>
                        <span class="text-xs text-gray-500 border rounded px-2 py-1">Next 12 months</span>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="scenario-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refine Panel -->
<div id="refine-panel" class="refine-panel">
    <div class="flex items-center justify-between px-5 py-4 border-b">
        <div class="refine-tabs flex-1">
            <div class="refine-tab active" onclick="switchRefineTab('chat')" id="tab-chat">Refine through chat</div>
            <div class="refine-tab" onclick="switchRefineTab('manual')" id="tab-manual">Refine manually</div>
        </div>
        <button onclick="closeRefinePanel()" class="text-gray-400 hover:text-gray-600 text-xl ml-4">&times;</button>
    </div>

    <!-- Chat Tab -->
    <div id="refine-chat" class="refine-content flex flex-col">
        <div id="chat-messages" class="chat-messages flex-1">
            <!-- HIRING Chat Prompts -->
            <div id="suggested-prompts-hiring" class="suggested-prompts">
                <h3>Explore your hiring scenario</h3>
                <p>Ask questions or request changes to the parameters</p>
                <div class="prompt-chips">
                    <button onclick="sendSuggestedPrompt('Break down the numbers')" class="quick-chip">Break down numbers</button>
                    <button onclick="sendSuggestedPrompt('Try $65,000 wages')" class="quick-chip">Try $65k wages</button>
                    <button onclick="sendSuggestedPrompt('What if capacity is only 15%?')" class="quick-chip">15% capacity instead</button>
                    <button onclick="sendSuggestedPrompt('Delay hire to Month 6')" class="quick-chip">Delay to Month 6</button>
                </div>
            </div>
            <!-- EXPANSION Chat Prompts -->
            <div id="suggested-prompts-expansion" class="suggested-prompts hidden">
                <h3>Explore your expansion scenario</h3>
                <p>Ask questions or request changes to the parameters</p>
                <div class="prompt-chips">
                    <button onclick="sendSuggestedPrompt('Explain the loss period')" class="quick-chip">Explain loss period</button>
                    <button onclick="sendSuggestedPrompt('Try $100,000 setup cost')" class="quick-chip">Try $100k setup</button>
                    <button onclick="sendSuggestedPrompt('What if overhead is $10,000?')" class="quick-chip">$10k overhead instead</button>
                    <button onclick="sendSuggestedPrompt('Open earlier in Month 3')" class="quick-chip">Open Month 3</button>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <div class="chat-input-wrap">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask a question or request a change..." onkeydown="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="chat-send">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Tab - HIRING -->
    <div id="refine-manual-hiring" class="refine-content hidden p-4">
        <div class="flex items-center justify-between mb-4">
            <div>
                <label class="text-xs text-gray-500 block mb-1">Source data</label>
                <select class="refine-select text-sm" style="width: auto; padding: 8px 12px;">
                    <option>Last 12 months (Xero P&L)</option>
                </select>
            </div>
            <span class="scenario-type-badge operational">OPERATIONAL</span>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Hire (with projects) <span class="scenario-line solid-blue"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="hiring-card-revenue-subtitle">$398,000 total profit â€¢ With new project revenue</p>
            <div class="refine-input-group">
                <label>Annual wages (inc. super)</label>
                <div class="refine-input-field">
                    <span>$</span>
                    <input type="text" id="hiring-salary-input" value="55,000" onchange="updateHiringSalary(this.value)">
                </div>
            </div>
            <div class="refine-input-group">
                <label>Project capacity increase</label>
                <div class="refine-slider-wrap">
                    <input type="range" min="5" max="40" value="20" id="hiring-capacity-slider" oninput="updateHiringCapacity(this.value)">
                    <span class="refine-slider-value" id="hiring-capacity-value">+20%</span>
                </div>
            </div>
            <div class="refine-input-group">
                <label>Hire start month</label>
                <select class="refine-select" id="hiring-start-month" onchange="updateHiringStartMonth(this.value)">
                    <option value="1">Month 1</option>
                    <option value="2">Month 2</option>
                    <option value="3" selected>Month 3</option>
                    <option value="4">Month 4</option>
                    <option value="6">Month 6</option>
                </select>
            </div>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Current trajectory <span class="scenario-line dotted"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="hiring-card-current-subtitle">$312,000 total profit â€¢ No hire</p>
            <div class="refine-input-group">
                <label>Organic growth</label>
                <div class="refine-slider-wrap">
                    <input type="range" min="0" max="15" value="5" id="hiring-baseline-slider" oninput="updateHiringBaseline(this.value)">
                    <span class="refine-slider-value" id="hiring-baseline-value">+5%</span>
                </div>
            </div>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Hire (cost only) <span class="scenario-line solid-red"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="hiring-card-cost-subtitle"><span class="loss-text">$266,167 total profit</span> â€¢ Shows cost impact only</p>
            <p class="text-xs text-gray-400">Uses same wages, no new project work</p>
        </div>
    </div>

    <!-- Manual Tab - EXPANSION -->
    <div id="refine-manual-expansion" class="refine-content hidden p-4">
        <div class="flex items-center justify-between mb-4">
            <div>
                <label class="text-xs text-gray-500 block mb-1">Source data</label>
                <select class="refine-select text-sm" style="width: auto; padding: 8px 12px;">
                    <option>Last 12 months (Xero P&L)</option>
                </select>
            </div>
            <span class="scenario-type-badge strategic">STRATEGIC</span>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Expand (with clients) <span class="scenario-line solid-green"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="expansion-card-revenue-subtitle">$376,000 total profit â€¢ With new regional clients</p>
            <div class="refine-input-group">
                <label>Setup/equipment cost</label>
                <div class="refine-input-field">
                    <span>$</span>
                    <input type="text" id="expansion-setup-input" value="75,000" onchange="updateExpansionSetup(this.value)">
                </div>
            </div>
            <div class="refine-input-group">
                <label>Monthly overhead (rent, utilities)</label>
                <div class="refine-input-field">
                    <span>$</span>
                    <input type="text" id="expansion-lease-input" value="8,000" onchange="updateExpansionLease(this.value)">
                </div>
            </div>
            <div class="refine-input-group">
                <label>Expected new project revenue</label>
                <div class="refine-input-field">
                    <span>$</span>
                    <input type="text" id="expansion-revenue-input" value="35,000" onchange="updateExpansionRevenue(this.value)">
                </div>
            </div>
            <div class="refine-input-group">
                <label>Opening month</label>
                <select class="refine-select" id="expansion-opening-month" onchange="updateExpansionOpeningMonth(this.value)">
                    <option value="3">Month 3</option>
                    <option value="4">Month 4</option>
                    <option value="5">Month 5</option>
                    <option value="6" selected>Month 6</option>
                    <option value="9">Month 9</option>
                </select>
            </div>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Current trajectory <span class="scenario-line dotted"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="expansion-card-current-subtitle">$318,500 total profit â€¢ No expansion</p>
            <p class="text-xs text-gray-400">5% organic growth assumed</p>
        </div>

        <div class="refine-card">
            <div class="refine-card-header">
                <div class="refine-card-title">Expand (cost only) <span class="scenario-line solid-red"></span></div>
                <button class="text-gray-400">&#8942;</button>
            </div>
            <p class="refine-card-subtitle" id="expansion-card-cost-subtitle"><span class="loss-text">$187,500 total profit</span> â€¢ Shows cost impact only</p>
            <p class="text-xs text-gray-400">Setup + overhead costs with no new project revenue</p>
        </div>
    </div>
</div>

<script>
// ============================================================================
// IRONBARK BUILDING CO - v34 LOCKED ACCOUNTING DATA
// ============================================================================
// All financial data is based on Australian construction industry benchmarks
// Source: ABS Construction Industry Statistics, MBA Housing Industry Outlook
// ============================================================================

// LOCKED CHART OF ACCOUNTS - Australian Construction Standard
const CHART_OF_ACCOUNTS = Object.freeze({
    // REVENUE ACCOUNTS (4000 series)
    REVENUE: {
        CONTRACT_RESIDENTIAL: { code: '4000', name: 'Contract Revenue - Residential', locked: true },
        CONTRACT_COMMERCIAL: { code: '4010', name: 'Contract Revenue - Commercial', locked: true },
        CONTRACT_RENOVATIONS: { code: '4020', name: 'Contract Revenue - Renovations', locked: true },
        PROGRESS_CLAIMS: { code: '4100', name: 'Progress Claims', locked: true },
        VARIATIONS: { code: '4200', name: 'Variation Revenue', locked: true }
    },
    // DIRECT COSTS (5000 series)
    COGS: {
        MATERIALS_TIMBER: { code: '5000', name: 'Materials - Timber', locked: true },
        MATERIALS_CONCRETE: { code: '5010', name: 'Materials - Concrete', locked: true },
        MATERIALS_STEEL: { code: '5020', name: 'Materials - Steel', locked: true },
        SUBCONTRACTOR_PLUMBING: { code: '5100', name: 'Subcontractor - Plumbing', locked: true },
        SUBCONTRACTOR_ELECTRICAL: { code: '5110', name: 'Subcontractor - Electrical', locked: true },
        SUBCONTRACTOR_CARPENTRY: { code: '5120', name: 'Subcontractor - Carpentry', locked: true },
        DIRECT_LABOUR: { code: '5200', name: 'Direct Labour - Wages', locked: true },
        DIRECT_SUPER: { code: '5210', name: 'Direct Labour - Super', locked: true }
    },
    // OPERATING EXPENSES (6000 series)
    OPEX: {
        WAGES_ADMIN: { code: '6000', name: 'Wages - Admin/Office', locked: true },
        WAGES_APPRENTICE: { code: '6010', name: 'Wages - Apprentices', locked: true },
        SUPER_ADMIN: { code: '6020', name: 'Superannuation - Admin', locked: true },
        WORKERS_COMP: { code: '6030', name: 'Workers Compensation', locked: true },
        RENT_DEPOT: { code: '6100', name: 'Rent - Depot/Warehouse', locked: true },
        UTILITIES_ELECTRICITY: { code: '6200', name: 'Utilities - Electricity', locked: true },
        UTILITIES_GAS: { code: '6210', name: 'Utilities - Gas', locked: true },
        UTILITIES_WATER: { code: '6220', name: 'Utilities - Water', locked: true },
        UTILITIES_PHONE: { code: '6230', name: 'Utilities - Internet/Phone', locked: true },
        INSURANCE_PL: { code: '6300', name: 'Insurance - Public Liability', locked: true },
        INSURANCE_CONTRACT: { code: '6310', name: 'Insurance - Contract Works', locked: true },
        MOTOR_FUEL: { code: '6400', name: 'Motor Vehicle - Fuel', locked: true },
        DEPRECIATION_EQUIPMENT: { code: '6800', name: 'Depreciation - Equipment', locked: true }
    },
    // ASSET ACCOUNTS (1000 series)
    ASSETS: {
        PLANT_EQUIPMENT: { code: '1400', name: 'Plant & Equipment', locked: true },
        MOTOR_VEHICLES: { code: '1500', name: 'Motor Vehicles', locked: true }
    }
});

// LOCKED BUSINESS FINANCIALS - Based on Australian Construction SME Benchmarks
// Source: ABS 8155.0 - Australian Industry, Construction Sector
const LOCKED_FINANCIALS = Object.freeze({
    // Organization Details
    businessName: 'Ironbark Building Co',
    abn: '12 345 678 901',
    industry: 'Residential Construction',
    location: 'Melbourne, VIC',
    employees: 8,

    // Revenue Breakdown (Monthly) - Locked to P&L
    revenue: {
        total: 180000,                    // $180k/month total
        residential: 108000,              // 60% - Code 4000
        renovations: 54000,               // 30% - Code 4020
        variations: 18000,                // 10% - Code 4200
        // VALIDATION: Must equal total
        _validate: function() { return this.residential + this.renovations + this.variations === this.total; }
    },

    // Cost of Sales (Monthly) - Locked to P&L
    directCosts: {
        total: 126000,                    // $126k/month (70% of revenue)
        materials: 54000,                 // 30% - Codes 5000-5090
        subcontractors: 45000,            // 25% - Codes 5100-5190
        directLabour: 27000,              // 15% - Codes 5200-5220
        // VALIDATION
        _validate: function() { return this.materials + this.subcontractors + this.directLabour === this.total; }
    },

    // Gross Profit
    grossProfit: 54000,                   // $54k/month (30% margin)
    grossMarginPercent: 30,

    // Operating Expenses (Monthly) - Locked to P&L
    operatingExpenses: {
        total: 29000,                     // $29k/month
        adminWages: 12000,                // Code 6000
        rent: 4500,                       // Code 6100
        utilities: 1800,                  // Codes 6200-6230
        insurance: 3200,                  // Codes 6300-6340
        motorVehicle: 2500,               // Codes 6400-6420
        depreciation: 3000,               // Code 6800
        other: 2000,                      // Codes 6500-6990
        // VALIDATION
        _validate: function() {
            return this.adminWages + this.rent + this.utilities + this.insurance +
                   this.motorVehicle + this.depreciation + this.other === this.total;
        }
    },

    // Net Profit - LOCKED
    netProfit: 25000,                     // $25k/month
    netMarginPercent: 13.9,               // 13.9% net margin (industry avg: 8-15%)

    // Annual Figures
    annualRevenue: 2160000,               // $2.16M
    annualProfit: 300000,                 // $300k

    // Industry Benchmarks (ABS/MBA)
    benchmarks: {
        grossMarginMin: 25,
        grossMarginMax: 35,
        netMarginMin: 8,
        netMarginMax: 15,
        labourToRevenueRatio: 0.15,
        materialsToRevenueRatio: 0.30,
        overheadToRevenueRatio: 0.16
    }
});

// LOCKED HIRING SCENARIO - Apprentice Tradesperson
// Based on Fair Work Australia Building & Construction Award 2024
const LOCKED_HIRING = Object.freeze({
    role: 'Apprentice Tradesperson (Carpentry)',
    awardClassification: 'MA000020 - Building and Construction General On-site Award',

    // Wages - Fair Work Compliant
    wages: {
        baseAnnual: 45833,                // Year 1 Apprentice (~$878/week)
        superRate: 11.5,                  // Super Guarantee 2024-25
        superAmount: 5271,                // 11.5% of base
        workersCompRate: 4.5,             // Construction industry rate
        workersCompAmount: 2062,          // 4.5% of base
        payrollTaxThreshold: 700000,      // VIC threshold
        payrollTaxRate: 4.85,             // VIC rate (exempt if under threshold)

        // TOTAL ANNUAL COST
        totalAnnual: 55000,               // Rounded ($45,833 + $5,271 + $2,062 + allowances)
        totalMonthly: 4583,               // $55k / 12

        // Account Codes
        accountCodes: ['6010', '6020', '6030']  // Wages, Super, Workers Comp
    },

    // Capacity Impact - Based on industry productivity metrics
    capacity: {
        defaultIncrease: 20,              // 20% more project capacity
        minIncrease: 5,                   // Absolute minimum
        maxIncrease: 40,                  // Maximum realistic increase
        rampUpMonths: 3,                  // Months to full productivity
        trainingProductivity: 0.6,        // 60% productivity during training

        // Account Codes
        accountCodes: ['4000', '4010', '4020']  // Revenue accounts affected
    },

    // Default Timeline
    startMonth: 3,
    baselineGrowth: 5                     // 5% organic growth without hire
});

// LOCKED EXPANSION SCENARIO - New Depot/Service Area
// Based on commercial lease rates and fit-out costs for Melbourne industrial areas
const LOCKED_EXPANSION = Object.freeze({
    type: 'New Regional Depot',
    location: 'Outer Melbourne (Dandenong/Melton corridor)',

    // Setup Costs - One-time Capital Expenditure
    setup: {
        total: 75000,                     // Total setup
        fitout: 25000,                    // Depot fit-out
        signage: 5000,                    // Signage & branding
        equipment: 30000,                 // Tools & equipment
        stockInitial: 10000,              // Initial materials stock
        legal: 3000,                      // Legal/lease costs
        contingency: 2000,                // 3% contingency

        // Account Codes
        accountCodes: ['1400', '6620', '1300']  // P&E, Legal, Inventory
    },

    // Ongoing Costs - Monthly Operating
    monthly: {
        total: 8000,                      // Total monthly overhead
        rent: 4500,                       // Industrial lease (~$250/sqm pa for 200sqm)
        utilities: 800,                   // Power, water, gas
        insurance: 700,                   // Additional PL & property
        admin: 1000,                      // Part-time admin
        misc: 1000,                       // Consumables, maintenance

        // Account Codes
        accountCodes: ['6100', '6200', '6300', '6000']
    },

    // Revenue Projection
    revenue: {
        expectedMonthly: 35000,           // New regional project revenue
        rampUpMonths: 4,                  // Months to full capacity
        conservativeMonthly: 25000,       // Conservative estimate
        optimisticMonthly: 50000,         // Optimistic estimate

        // Account Codes
        accountCodes: ['4000', '4020']    // Residential & renovations
    },

    // Default Timeline
    openingMonth: 6
});

// ============ STATE (Initialized from locked data) ============
const state = {
    apiKey: localStorage.getItem('anthropic_api_key') || '',
    scenarioType: null,
    chatMessages: [],

    // BASE FINANCIALS - From locked data
    baseRevenue: LOCKED_FINANCIALS.revenue.total,
    baseCosts: LOCKED_FINANCIALS.directCosts.total + LOCKED_FINANCIALS.operatingExpenses.total,
    baseProfit: LOCKED_FINANCIALS.netProfit,

    // HIRING SCENARIO - From locked data
    hiring: {
        annualSalary: LOCKED_HIRING.wages.totalAnnual,
        capacityIncrease: LOCKED_HIRING.capacity.defaultIncrease,
        baselineGrowth: LOCKED_HIRING.baselineGrowth,
        startMonth: LOCKED_HIRING.startMonth
    },

    // EXPANSION SCENARIO - From locked data
    expansion: {
        setupCost: LOCKED_EXPANSION.setup.total,
        monthlyOverhead: LOCKED_EXPANSION.monthly.total,
        expectedRevenue: LOCKED_EXPANSION.revenue.expectedMonthly,
        openingMonth: LOCKED_EXPANSION.openingMonth
    }
};

let chart = null;
let chartData = {};

// ============ NAVIGATION ============
function goHome() {
    document.getElementById('home-view').classList.add('active');
    document.getElementById('scenario-view').classList.remove('active');
    closeRefinePanel();
}

function selectTemplate(type) {
    closeSetupModal();
    loadScenario(type);
}

function submitScenario() {
    const q = document.getElementById('scenario-question').value.toLowerCase();
    const type = (q.includes('hire') || q.includes('apprentice') || q.includes('staff') || q.includes('tradesperson') || q.includes('wage') || q.includes('carpenter')) ? 'hiring' : 'expansion';
    closeSetupModal();
    loadScenario(type);
}

function loadScenario(type) {
    state.scenarioType = type;

    document.getElementById('home-view').classList.remove('active');
    document.getElementById('scenario-view').classList.add('active');

    document.getElementById('scenario-title').textContent = type === 'hiring'
        ? 'Can I afford to hire an apprentice carpenter?'
        : 'Should I expand to a new service area?';

    document.getElementById('key-insight-hiring').classList.toggle('hidden', type !== 'hiring');
    document.getElementById('key-insight-expansion').classList.toggle('hidden', type !== 'expansion');
    document.getElementById('scenario-key-hiring').classList.toggle('hidden', type !== 'hiring');
    document.getElementById('scenario-key-expansion').classList.toggle('hidden', type !== 'expansion');
    document.getElementById('suggested-prompts-hiring').classList.toggle('hidden', type !== 'hiring');
    document.getElementById('suggested-prompts-expansion').classList.toggle('hidden', type !== 'expansion');

    renderChart();
    updateAllDisplays();
}

// ============ MODALS ============
function openSetupModal() { document.getElementById('setup-modal').classList.add('open'); }
function closeSetupModal() { document.getElementById('setup-modal').classList.remove('open'); document.getElementById('scenario-question').value = ''; }
function openShareModal() { document.getElementById('share-modal').classList.add('open'); }
function closeShareModal() { document.getElementById('share-modal').classList.remove('open'); }

function sendToAdvisor() {
    const email = document.getElementById('advisor-email').value;
    if (!email) { showToast('Please enter advisor email', true); return; }
    showToast('Scenario shared with ' + email);
    closeShareModal();
}

function openApiModal() {
    document.getElementById('api-modal').classList.remove('hidden');
    document.getElementById('api-modal').classList.add('flex');
    if (state.apiKey) {
        document.getElementById('api-key-input').value = state.apiKey;
        document.getElementById('clear-key-btn').classList.remove('hidden');
    }
}

function closeApiModal() {
    document.getElementById('api-modal').classList.add('hidden');
    document.getElementById('api-modal').classList.remove('flex');
}

function saveApiKey() {
    const key = document.getElementById('api-key-input').value.trim();
    if (!key || !key.startsWith('sk-ant-')) { showApiStatus('Invalid API key format', false); return; }
    localStorage.setItem('anthropic_api_key', key);
    state.apiKey = key;
    showApiStatus('API key saved!', true);
    document.getElementById('clear-key-btn').classList.remove('hidden');
    updateApiStatusIndicator();
    setTimeout(closeApiModal, 800);
}

function clearApiKey() {
    localStorage.removeItem('anthropic_api_key');
    state.apiKey = '';
    document.getElementById('api-key-input').value = '';
    document.getElementById('clear-key-btn').classList.add('hidden');
    showApiStatus('API key cleared', true);
    updateApiStatusIndicator();
}

function showApiStatus(msg, success) {
    document.getElementById('api-status-container').textContent = msg;
    document.getElementById('api-status-container').className = 'text-sm p-3 rounded-lg ' + (success ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700');
    document.getElementById('api-status').classList.remove('hidden');
}

function updateApiStatusIndicator() {
    const el = document.getElementById('api-status-indicator');
    if (!el) return;
    el.innerHTML = state.apiKey
        ? '<span class="text-green-600 font-medium">Claude API Connected</span>'
        : '<span class="text-orange-600 font-medium">API Key Required</span>';
    el.className = 'text-xs px-2 py-1 rounded cursor-pointer ' + (state.apiKey ? 'bg-green-100' : 'bg-orange-100');
}

// ============ REFINE PANEL ============
function openRefinePanel() {
    document.getElementById('refine-panel').classList.add('open');
    document.getElementById('left-panel').classList.add('collapsed');
}

function closeRefinePanel() {
    document.getElementById('refine-panel').classList.remove('open');
    document.getElementById('left-panel').classList.remove('collapsed');
}

function openRefineManual() {
    openRefinePanel();
    switchRefineTab('manual');
}

function switchRefineTab(tab) {
    document.getElementById('tab-chat').classList.toggle('active', tab === 'chat');
    document.getElementById('tab-manual').classList.toggle('active', tab === 'manual');
    document.getElementById('refine-chat').classList.toggle('hidden', tab !== 'chat');
    document.getElementById('refine-manual-hiring').classList.toggle('hidden', tab !== 'manual' || state.scenarioType !== 'hiring');
    document.getElementById('refine-manual-expansion').classList.toggle('hidden', tab !== 'manual' || state.scenarioType !== 'expansion');
}

// ============ HIRING MANUAL CONTROLS (with validation) ============
function updateHiringSalary(value) {
    let salary = parseInt(value.replace(/,/g, '')) || LOCKED_HIRING.wages.totalAnnual;
    // Validate against Fair Work minimum
    const minWage = 40000;  // Minimum apprentice wage
    const maxWage = 150000; // Maximum realistic for scenario
    salary = Math.max(minWage, Math.min(maxWage, salary));

    state.hiring.annualSalary = salary;
    document.getElementById('hiring-salary-input').value = salary.toLocaleString();
    renderChart();
    updateAllDisplays();
}

function updateHiringCapacity(value) {
    let capacity = parseInt(value);
    // Validate against locked limits
    capacity = Math.max(LOCKED_HIRING.capacity.minIncrease, Math.min(LOCKED_HIRING.capacity.maxIncrease, capacity));

    state.hiring.capacityIncrease = capacity;
    document.getElementById('hiring-capacity-value').textContent = '+' + capacity + '%';
    renderChart();
    updateAllDisplays();
}

function updateHiringBaseline(value) {
    state.hiring.baselineGrowth = parseInt(value);
    document.getElementById('hiring-baseline-value').textContent = '+' + value + '%';
    renderChart();
    updateAllDisplays();
}

function updateHiringStartMonth(value) {
    state.hiring.startMonth = parseInt(value);
    renderChart();
    updateAllDisplays();
}

// ============ EXPANSION MANUAL CONTROLS (with validation) ============
function updateExpansionSetup(value) {
    let setup = parseInt(value.replace(/,/g, '')) || LOCKED_EXPANSION.setup.total;
    // Validate reasonable range
    setup = Math.max(25000, Math.min(200000, setup));

    state.expansion.setupCost = setup;
    document.getElementById('expansion-setup-input').value = setup.toLocaleString();
    renderChart();
    updateAllDisplays();
}

function updateExpansionLease(value) {
    let lease = parseInt(value.replace(/,/g, '')) || LOCKED_EXPANSION.monthly.total;
    // Validate reasonable range
    lease = Math.max(3000, Math.min(25000, lease));

    state.expansion.monthlyOverhead = lease;
    document.getElementById('expansion-lease-input').value = lease.toLocaleString();
    renderChart();
    updateAllDisplays();
}

function updateExpansionRevenue(value) {
    let revenue = parseInt(value.replace(/,/g, '')) || LOCKED_EXPANSION.revenue.expectedMonthly;
    // Validate against conservative/optimistic range
    revenue = Math.max(LOCKED_EXPANSION.revenue.conservativeMonthly, Math.min(LOCKED_EXPANSION.revenue.optimisticMonthly, revenue));

    state.expansion.expectedRevenue = revenue;
    document.getElementById('expansion-revenue-input').value = revenue.toLocaleString();
    renderChart();
    updateAllDisplays();
}

function updateExpansionOpeningMonth(value) {
    state.expansion.openingMonth = parseInt(value);
    renderChart();
    updateAllDisplays();
}

// ============ CHART ============
function renderChart() {
    const ctx = document.getElementById('scenario-chart').getContext('2d');
    if (chart) chart.destroy();

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    const labels = ['Now'];
    for (let i = 1; i <= 12; i++) labels.push(monthNames[(currentMonth + i) % 12]);

    let datasets = [];

    if (state.scenarioType === 'hiring') {
        const salary = state.hiring.annualSalary;
        const capacityIncrease = state.hiring.capacityIncrease;
        const baselineGrowth = state.hiring.baselineGrowth;
        const startMonth = state.hiring.startMonth;
        const monthlySalary = salary / 12;
        const monthlyGrowth = state.baseProfit * (baselineGrowth / 100 / 12);
        const newProjectRevenue = state.baseRevenue * (capacityIncrease / 100);

        // Current trajectory - using locked baseline
        const currentData = labels.map((_, i) => Math.round(state.baseProfit + (i * monthlyGrowth)));

        // Cost only - wages impact with no new revenue
        const costOnlyData = labels.map((_, i) => {
            let profit = state.baseProfit + (i * monthlyGrowth);
            if (i >= startMonth) {
                profit -= monthlySalary;
            }
            return Math.round(profit);
        });

        // With projects - wages + ramped revenue
        const revenueData = labels.map((_, i) => {
            let profit = state.baseProfit + (i * monthlyGrowth);
            if (i >= startMonth) {
                profit -= monthlySalary;
                const monthsActive = i - startMonth + 1;
                const ramp = Math.min(1, monthsActive / LOCKED_HIRING.capacity.rampUpMonths);
                profit += newProjectRevenue * ramp;
            }
            return Math.round(profit);
        });

        chartData = { current: currentData, costOnly: costOnlyData, withRevenue: revenueData };

        datasets = [
            { label: 'Current trajectory', data: currentData, borderColor: '#94A3B8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 },
            { label: 'Hire (cost only)', data: costOnlyData, borderColor: '#EF4444', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 },
            { label: 'Hire (with projects)', data: revenueData, borderColor: '#1C7ED6', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 }
        ];

    } else {
        const setup = state.expansion.setupCost;
        const overhead = state.expansion.monthlyOverhead;
        const newRev = state.expansion.expectedRevenue;
        const openMonth = state.expansion.openingMonth;
        const monthlyGrowth = state.baseProfit * 0.05 / 12;

        // Current trajectory
        const currentData = labels.map((_, i) => Math.round(state.baseProfit + (i * monthlyGrowth)));

        // Cost only - setup hit + ongoing overhead
        const costOnlyData = labels.map((_, i) => {
            let profit = state.baseProfit + (i * monthlyGrowth);
            if (i === openMonth) profit -= setup;
            if (i >= openMonth) profit -= overhead;
            return Math.round(profit);
        });

        // With clients - costs + ramped revenue
        const revenueData = labels.map((_, i) => {
            let profit = state.baseProfit + (i * monthlyGrowth);
            if (i === openMonth) profit -= setup;
            if (i >= openMonth) {
                profit -= overhead;
                const monthsOpen = i - openMonth + 1;
                const ramp = Math.min(1, monthsOpen / LOCKED_EXPANSION.revenue.rampUpMonths);
                profit += newRev * ramp;
            }
            return Math.round(profit);
        });

        chartData = { current: currentData, costOnly: costOnlyData, withRevenue: revenueData };

        datasets = [
            { label: 'Current trajectory', data: currentData, borderColor: '#94A3B8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 },
            { label: 'Expand (cost only)', data: costOnlyData, borderColor: '#EF4444', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 },
            { label: 'Expand (with clients)', data: revenueData, borderColor: '#10B981', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 0 }
        ];
    }

    // Calculate dynamic Y-axis range for better visibility of changes
    const allData = [...(chartData.current || []), ...(chartData.costOnly || []), ...(chartData.withRevenue || [])];
    const dataMin = Math.min(...allData);
    const dataMax = Math.max(...allData);
    const padding = (dataMax - dataMin) * 0.15; // 15% padding
    const yMin = Math.floor((dataMin - padding) / 1000) * 1000;
    const yMax = Math.ceil((dataMax + padding) / 1000) * 1000;

    chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: $${Math.round(ctx.parsed.y).toLocaleString()}` } }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Monthly Profit (AUD)' },
                    min: yMin,
                    max: yMax,
                    ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' },
                    grid: { color: '#F1F5F9' }
                },
                x: { grid: { display: false } }
            }
        }
    });
}

// ============ UPDATE ALL DISPLAYS ============
function updateAllDisplays() {
    const totalCurrent = (chartData.current || []).reduce((a, b) => a + b, 0);
    const totalCost = (chartData.costOnly || []).reduce((a, b) => a + b, 0);
    const totalRevenue = (chartData.withRevenue || []).reduce((a, b) => a + b, 0);

    if (state.scenarioType === 'hiring') {
        const salary = state.hiring.annualSalary;
        const capacity = state.hiring.capacityIncrease;
        const newWork = Math.round(state.baseRevenue * (capacity / 100));
        const breakeven = Math.ceil(salary / (newWork * 12) * 12);

        document.getElementById('hiring-insight-title').textContent =
            `An apprentice hire pays for itself by Month ${state.hiring.startMonth + breakeven - 1} with increased project capacity`;
        document.getElementById('hiring-insight-desc').textContent =
            `With $${state.baseRevenue.toLocaleString()} monthly revenue and ${capacity}% capacity increase, a $${salary.toLocaleString()} apprentice generating ~$${newWork.toLocaleString()}/mo in new project work covers their cost within ${breakeven} months.`;

        document.getElementById('hiring-current-desc').textContent = `$${Math.round(totalCurrent).toLocaleString()} total profit â€¢ No hire`;
        document.getElementById('hiring-cost-desc').innerHTML = `<span class="loss-text">$${Math.round(totalCost).toLocaleString()} total profit</span> â€¢ Wages cost, no new projects`;
        document.getElementById('hiring-revenue-desc').textContent = `$${Math.round(totalRevenue).toLocaleString()} total profit â€¢ With new project revenue`;
        document.getElementById('hiring-wages-chip').textContent = `Wages: $${(salary/1000).toFixed(0)}k/yr`;
        document.getElementById('hiring-revenue-chip').textContent = `Capacity: +${capacity}%`;

        document.getElementById('hiring-card-current-subtitle').textContent = `$${Math.round(totalCurrent).toLocaleString()} total profit â€¢ No hire`;
        document.getElementById('hiring-card-cost-subtitle').innerHTML = `<span class="loss-text">$${Math.round(totalCost).toLocaleString()} total profit</span> â€¢ Shows cost impact only`;
        document.getElementById('hiring-card-revenue-subtitle').textContent = `$${Math.round(totalRevenue).toLocaleString()} total profit â€¢ With new project revenue`;

    } else {
        const setup = state.expansion.setupCost;
        const overhead = state.expansion.monthlyOverhead;
        const newRev = state.expansion.expectedRevenue;
        const netMonthly = newRev - overhead;
        const paybackMonths = Math.ceil(setup / netMonthly);
        const lossUntilMonth = state.expansion.openingMonth + paybackMonths;

        document.getElementById('expansion-insight-title').textContent =
            `New depot breakeven in ${paybackMonths} months â€” but expect losses until Month ${lossUntilMonth}`;
        document.getElementById('expansion-insight-desc').textContent =
            `Your $${setup.toLocaleString()} setup cost + $${overhead.toLocaleString()}/mo overhead vs $${newRev.toLocaleString()}/mo expected revenue = breakeven in ${paybackMonths} months post-opening.`;

        document.getElementById('expansion-current-desc').textContent = `$${Math.round(totalCurrent).toLocaleString()} total profit â€¢ No expansion`;
        document.getElementById('expansion-cost-desc').innerHTML = `<span class="loss-text">$${Math.round(totalCost).toLocaleString()} total profit</span> â€¢ Setup + overhead, no new clients`;
        document.getElementById('expansion-revenue-desc').textContent = `$${Math.round(totalRevenue).toLocaleString()} total profit â€¢ With new regional clients`;
        document.getElementById('expansion-setup-chip').textContent = `Setup: $${(setup/1000).toFixed(0)}k`;
        document.getElementById('expansion-newrev-chip').textContent = `New work: +$${(newRev/1000).toFixed(0)}k/mo`;
        document.getElementById('expansion-payback-text').textContent = `Breakeven in ${paybackMonths} months post-opening. Expect losses until Month ${lossUntilMonth}.`;

        document.getElementById('expansion-card-current-subtitle').textContent = `$${Math.round(totalCurrent).toLocaleString()} total profit â€¢ No expansion`;
        document.getElementById('expansion-card-cost-subtitle').innerHTML = `<span class="loss-text">$${Math.round(totalCost).toLocaleString()} total profit</span> â€¢ Shows cost impact only`;
        document.getElementById('expansion-card-revenue-subtitle').textContent = `$${Math.round(totalRevenue).toLocaleString()} total profit â€¢ With new regional clients`;
    }
}

// ============ CHAT ============
function askQuickReply(prompt) {
    openRefinePanel();
    switchRefineTab('chat');
    document.getElementById('chat-input').value = prompt;
    sendChatMessage();
}

function sendSuggestedPrompt(prompt) {
    document.getElementById('chat-input').value = prompt;
    sendChatMessage();
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    document.getElementById('suggested-prompts-hiring').style.display = 'none';
    document.getElementById('suggested-prompts-expansion').style.display = 'none';

    addChatMessage(message, 'user');
    input.value = '';

    if (!state.apiKey) { openApiModal(); return; }

    const typingId = showTypingIndicator();

    try {
        const response = await callClaudeAPI(message);
        removeTypingIndicator(typingId);
        addChatMessage(response, 'ai');
        parseAndUpdate(message);
    } catch (error) {
        removeTypingIndicator(typingId);
        addChatMessage('Error: ' + (error.message || 'Please check your API key.'), 'ai');
        console.error('API Error:', error);
    }
}

function addChatMessage(content, type) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = type === 'user' ? 'user-message chat-bubble' : 'ai-message chat-bubble';
    div.innerHTML = type === 'user'
        ? `<div class="user-bubble">${escapeHtml(content)}</div>`
        : `<div class="ai-bubble">${formatResponse(content)}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function formatResponse(content) {
    let html = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .split('\n\n')
        .filter(p => p.trim())
        .map(p => {
            p = p.trim();
            if (p.startsWith('- ') || p.startsWith('â€¢ ')) {
                const items = p.split('\n').map(line => line.replace(/^[-â€¢]\s*/, '').trim()).filter(line => line);
                return '<ul>' + items.map(item => `<li>${item}</li>`).join('') + '</ul>';
            }
            return `<p>${p.replace(/\n/g, '<br>')}</p>`;
        })
        .join('');
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showTypingIndicator() {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.id = 'typing';
    div.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
    container.appendChild(div);
    return 'typing';
}

function removeTypingIndicator() { document.getElementById('typing')?.remove(); }

async function callClaudeAPI(message) {
    // ============================================================================
    // GROUNDED SYSTEM PROMPT - Uses ONLY locked accounting data
    // ============================================================================
    const baseContext = `You are a financial assistant for ${LOCKED_FINANCIALS.businessName}, a ${LOCKED_FINANCIALS.industry.toLowerCase()} company in ${LOCKED_FINANCIALS.location}.

STRICT RULES - YOU MUST FOLLOW THESE:
1. ONLY use the EXACT numbers provided below - these are from the verified P&L
2. DO NOT invent, estimate, or assume ANY costs, percentages, or figures
3. If asked about data not provided below, say "That data isn't in the current P&L extract - we'd need to connect more accounts"
4. NEVER mention account codes (like 4000, 6010, etc.) to users - speak in plain business language only
5. Be concise (80-100 words max)
6. Use Australian dollars (AUD)

VERIFIED P&L DATA (Last 12 months):

REVENUE (4000 Series):
- Total Monthly Revenue: $${LOCKED_FINANCIALS.revenue.total.toLocaleString()}
  - Residential (4000): $${LOCKED_FINANCIALS.revenue.residential.toLocaleString()}
  - Renovations (4020): $${LOCKED_FINANCIALS.revenue.renovations.toLocaleString()}
  - Variations (4200): $${LOCKED_FINANCIALS.revenue.variations.toLocaleString()}

DIRECT COSTS (5000 Series):
- Total COGS: $${LOCKED_FINANCIALS.directCosts.total.toLocaleString()}/mo (${Math.round(LOCKED_FINANCIALS.directCosts.total/LOCKED_FINANCIALS.revenue.total*100)}% of revenue)
  - Materials (5000-5090): $${LOCKED_FINANCIALS.directCosts.materials.toLocaleString()}
  - Subcontractors (5100-5190): $${LOCKED_FINANCIALS.directCosts.subcontractors.toLocaleString()}
  - Direct Labour (5200-5220): $${LOCKED_FINANCIALS.directCosts.directLabour.toLocaleString()}

GROSS PROFIT: $${LOCKED_FINANCIALS.grossProfit.toLocaleString()}/mo (${LOCKED_FINANCIALS.grossMarginPercent}% margin)

OPERATING EXPENSES (6000 Series):
- Total OPEX: $${LOCKED_FINANCIALS.operatingExpenses.total.toLocaleString()}/mo
  - Admin Wages (6000): $${LOCKED_FINANCIALS.operatingExpenses.adminWages.toLocaleString()}
  - Rent (6100): $${LOCKED_FINANCIALS.operatingExpenses.rent.toLocaleString()}
  - Utilities (6200-6230): $${LOCKED_FINANCIALS.operatingExpenses.utilities.toLocaleString()}
  - Insurance (6300-6340): $${LOCKED_FINANCIALS.operatingExpenses.insurance.toLocaleString()}
  - Motor Vehicle (6400-6420): $${LOCKED_FINANCIALS.operatingExpenses.motorVehicle.toLocaleString()}
  - Depreciation (6800): $${LOCKED_FINANCIALS.operatingExpenses.depreciation.toLocaleString()}

NET PROFIT: $${LOCKED_FINANCIALS.netProfit.toLocaleString()}/mo (${LOCKED_FINANCIALS.netMarginPercent}% margin)`;

    let scenarioContext = '';

    if (state.scenarioType === 'hiring') {
        const newWork = Math.round(state.baseRevenue * (state.hiring.capacityIncrease / 100));
        scenarioContext = `

HIRING SCENARIO - ${LOCKED_HIRING.role}
Award: ${LOCKED_HIRING.awardClassification}

WAGE COSTS (Account Codes: ${LOCKED_HIRING.wages.accountCodes.join(', ')}):
- Base Wages (6010): $${LOCKED_HIRING.wages.baseAnnual.toLocaleString()}/yr
- Super @ ${LOCKED_HIRING.wages.superRate}% (6020): $${LOCKED_HIRING.wages.superAmount.toLocaleString()}/yr
- Workers Comp @ ${LOCKED_HIRING.wages.workersCompRate}% (6030): $${LOCKED_HIRING.wages.workersCompAmount.toLocaleString()}/yr
- TOTAL ANNUAL COST: $${state.hiring.annualSalary.toLocaleString()} ($${Math.round(state.hiring.annualSalary/12).toLocaleString()}/month)

CAPACITY IMPACT (Account Codes: ${LOCKED_HIRING.capacity.accountCodes.join(', ')}):
- Expected Capacity Increase: ${state.hiring.capacityIncrease}%
- New Monthly Project Revenue: ~$${newWork.toLocaleString()}
- Ramp-up Period: ${LOCKED_HIRING.capacity.rampUpMonths} months to full productivity
- Start Month: ${state.hiring.startMonth}
- Organic Growth (baseline): ${state.hiring.baselineGrowth}%

The RED "cost only" line shows wages impact if you hire but don't win new projects.
The BLUE "with projects" line shows the outcome with increased capacity utilised.`;
    } else {
        const netMonthly = state.expansion.expectedRevenue - state.expansion.monthlyOverhead;
        const payback = Math.ceil(state.expansion.setupCost / netMonthly);
        scenarioContext = `

EXPANSION SCENARIO - ${LOCKED_EXPANSION.type}
Location: ${LOCKED_EXPANSION.location}

SETUP COSTS (One-time, Account Codes: ${LOCKED_EXPANSION.setup.accountCodes.join(', ')}):
- Fit-out (1400): $${LOCKED_EXPANSION.setup.fitout.toLocaleString()}
- Equipment (1400): $${LOCKED_EXPANSION.setup.equipment.toLocaleString()}
- Signage: $${LOCKED_EXPANSION.setup.signage.toLocaleString()}
- Initial Stock (1300): $${LOCKED_EXPANSION.setup.stockInitial.toLocaleString()}
- Legal (6620): $${LOCKED_EXPANSION.setup.legal.toLocaleString()}
- TOTAL SETUP: $${state.expansion.setupCost.toLocaleString()}

MONTHLY OVERHEAD (Account Codes: ${LOCKED_EXPANSION.monthly.accountCodes.join(', ')}):
- Rent (6100): $${LOCKED_EXPANSION.monthly.rent.toLocaleString()}
- Utilities (6200): $${LOCKED_EXPANSION.monthly.utilities.toLocaleString()}
- Insurance (6300): $${LOCKED_EXPANSION.monthly.insurance.toLocaleString()}
- Admin (6000): $${LOCKED_EXPANSION.monthly.admin.toLocaleString()}
- TOTAL MONTHLY: $${state.expansion.monthlyOverhead.toLocaleString()}

REVENUE PROJECTION (Account Codes: ${LOCKED_EXPANSION.revenue.accountCodes.join(', ')}):
- Expected New Revenue: $${state.expansion.expectedRevenue.toLocaleString()}/mo
- Conservative Estimate: $${LOCKED_EXPANSION.revenue.conservativeMonthly.toLocaleString()}/mo
- Optimistic Estimate: $${LOCKED_EXPANSION.revenue.optimisticMonthly.toLocaleString()}/mo
- Ramp-up Period: ${LOCKED_EXPANSION.revenue.rampUpMonths} months
- Opening Month: ${state.expansion.openingMonth}
- Net Monthly Gain: $${netMonthly.toLocaleString()}
- Payback Period: ~${payback} months

The RED "cost only" line shows what happens if you expand but don't win new clients.
The GREEN "with clients" line shows recovery with expected regional project work.`;
    }

    const systemPrompt = baseContext + scenarioContext;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 400,
            system: systemPrompt,
            messages: [{ role: 'user', content: message }]
        })
    });

    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
    }

    const data = await response.json();
    return data.content[0].text;
}

function parseAndUpdate(msg) {
    const m = msg.toLowerCase();
    let updated = false;

    if (state.scenarioType === 'hiring') {
        const salaryMatch = m.match(/\$?([\d,]+)(?:k)?\s*(?:wages|salary)?/);
        if (salaryMatch) {
            let s = parseInt(salaryMatch[1].replace(/,/g, ''));
            if (m.includes('k') && s < 1000) s *= 1000;
            if (s >= 40000 && s <= 150000) {
                state.hiring.annualSalary = s;
                document.getElementById('hiring-salary-input').value = s.toLocaleString();
                updated = true;
            }
        }
        const capacityMatch = m.match(/(\d+)\s*%?\s*(?:capacity|increase)/);
        if (capacityMatch) {
            const c = parseInt(capacityMatch[1]);
            if (c >= LOCKED_HIRING.capacity.minIncrease && c <= LOCKED_HIRING.capacity.maxIncrease) {
                state.hiring.capacityIncrease = c;
                document.getElementById('hiring-capacity-slider').value = c;
                document.getElementById('hiring-capacity-value').textContent = '+' + c + '%';
                updated = true;
            }
        }
        if (m.includes('delay') || m.includes('month 6')) {
            state.hiring.startMonth = 6;
            document.getElementById('hiring-start-month').value = 6;
            updated = true;
        }
    } else {
        const setupMatch = m.match(/\$?([\d,]+)(?:k)?\s*(?:setup|equipment)/);
        if (setupMatch) {
            let s = parseInt(setupMatch[1].replace(/,/g, ''));
            if (m.includes('k') && s < 1000) s *= 1000;
            if (s >= 25000 && s <= 200000) {
                state.expansion.setupCost = s;
                document.getElementById('expansion-setup-input').value = s.toLocaleString();
                updated = true;
            }
        }
        const overheadMatch = m.match(/\$?([\d,]+)(?:k)?\s*(?:overhead|rent)/);
        if (overheadMatch) {
            const oh = parseInt(overheadMatch[1].replace(/,/g, ''));
            if (oh >= 3000 && oh <= 25000) {
                state.expansion.monthlyOverhead = oh;
                document.getElementById('expansion-lease-input').value = oh.toLocaleString();
                updated = true;
            }
        }
        if (m.includes('month 3') || m.includes('earlier')) {
            state.expansion.openingMonth = 3;
            document.getElementById('expansion-opening-month').value = 3;
            updated = true;
        }
    }

    if (updated) {
        renderChart();
        updateAllDisplays();
        showToast('Chart updated');
    }
}

// ============ UTILITIES ============
function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('anthropic_api_key')) {
        state.apiKey = localStorage.getItem('anthropic_api_key');
    }
    updateApiStatusIndicator();

    // Validate locked data on load
    console.log('ðŸ“Š Ironbark Building Co v34 - Locked Accounting Data');
    console.log('Revenue validation:', LOCKED_FINANCIALS.revenue._validate() ? 'âœ“' : 'âœ—');
    console.log('Direct costs validation:', LOCKED_FINANCIALS.directCosts._validate() ? 'âœ“' : 'âœ—');
    console.log('OPEX validation:', LOCKED_FINANCIALS.operatingExpenses._validate() ? 'âœ“' : 'âœ—');
});
</script>

</body>
</html>
